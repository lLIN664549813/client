<template>
  <view class="message-page">
    <nav-bar title="消息" :showBack="false"></nav-bar>
    <view class="message-content">
      <uni-list :border="false">
        <uni-list-chat
          v-for="(item, index) in convosList"
          :key="item.convosId || `${item.withId}-${index}`"
          :avatar-circle="true"
          :title="item.name || '会话消息'"
          :avatar="item.avatar || defaultAvatar"
          :note="item.lastMsgNote || '暂无消息'"
          :time="item.lastMsgTimeText"
          badge-positon="left"
          :badge-text="item.badgeText"
          link
          @click="goToChat(item)"
        ></uni-list-chat>
      </uni-list>

      <view v-if="!loading && convosList.length === 0" class="empty-wrap">
        <text class="empty-text">暂无消息</text>
      </view>
    </view>
  </view>
</template>

<script>
import config from "@/config";
import NavBar from "@/components/nav-bar/nav-bar.vue";
import { queryConvosList, zeroConvosUnread } from "@/api/message";

const baseUrl = config.baseUrl;

export default {
  components: {
    NavBar,
  },
  data() {
    return {
      loading: false,
      convosList: [],
      defaultAvatar: "/static/images/profile.jpg",
    };
  },
  onShow() {
    this.loadConvosList();
  },
  onPullDownRefresh() {
    this.loadConvosList().finally(() => uni.stopPullDownRefresh());
  },
  methods: {
    async loadConvosList() {
      if (this.loading) {
        return;
      }
      this.loading = true;
      try {
        const res = await queryConvosList();
        const rows = this.extractRows(res);
        this.convosList = rows.map((item) => this.mapConvosItem(item));
      } catch (e) {
        this.convosList = [];
      } finally {
        this.loading = false;
      }
    },
    extractRows(res) {
      if (!res) {
        return [];
      }
      const data = Object.prototype.hasOwnProperty.call(res, "data") ? res.data : res;
      if (Array.isArray(data)) {
        return data;
      }
      if (data && Array.isArray(data.rows)) {
        return data.rows;
      }
      if (data && Array.isArray(data.list)) {
        return data.list;
      }
      if (data && Array.isArray(data.records)) {
        return data.records;
      }
      if (Array.isArray(res.rows)) {
        return res.rows;
      }
      if (Array.isArray(res.list)) {
        return res.list;
      }
      return [];
    },
    mapConvosItem(item) {
      const unreadCount = Number(item.unreadCount || 0);
      return {
        ...item,
        convosId: Number(item.convosId || 0),
        withId: Number(item.withId || 0),
        type: Number(item.type || 0),
        name: item.name || item.nickname || "会话消息",
        avatar: this.normalizeAvatar(item.avatar),
        lastMsgNote: item.lastMsgNote || "",
        lastMsgTimeText: this.formatTime(item.lastMsgTime || item.updateTime || item.createTime),
        badgeText: unreadCount > 0 ? String(unreadCount) : "",
      };
    },
    normalizeAvatar(url) {
      if (!url) {
        return this.defaultAvatar;
      }
      if (/^https?:\/\//i.test(url)) {
        return url;
      }
      return `${baseUrl}${url}`;
    },
    formatTime(value) {
      if (!value) {
        return "";
      }
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) {
        return String(value);
      }
      const now = new Date();
      const isToday =
        now.getFullYear() === date.getFullYear() &&
        now.getMonth() === date.getMonth() &&
        now.getDate() === date.getDate();
      const pad = (num) => String(num).padStart(2, "0");
      if (isToday) {
        return `${pad(date.getHours())}:${pad(date.getMinutes())}`;
      }
      return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}`;
    },
    async goToChat(item) {
      try {
        await zeroConvosUnread({
          convosId: item.convosId || undefined,
          withId: item.withId || undefined,
        });
      } catch (e) {
        // ignore
      }
      const query = [
        `convosId=${encodeURIComponent(String(item.convosId || ""))}`,
        `withId=${encodeURIComponent(String(item.withId || ""))}`,
        `type=${encodeURIComponent(String(item.type || 0))}`,
        `name=${encodeURIComponent(item.name || "会话消息")}`,
        `avatar=${encodeURIComponent(item.avatar || "")}`,
      ].join("&");
      uni.navigateTo({
        url: `/pages/message/details?${query}`,
      });
    },
  },
};
</script>

<style scoped lang="scss">
.message-page {
  min-height: 100vh;
  background: #ffffff;
}

.message-content {
  padding: 20rpx 24rpx;
}

.empty-wrap {
  padding: 120rpx 0;
  text-align: center;
}

.empty-text {
  font-size: 28rpx;
  color: #999999;
}
</style>
