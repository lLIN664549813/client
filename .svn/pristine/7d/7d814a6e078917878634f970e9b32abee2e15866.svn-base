<template>
  <view class="normal-login-container">
    <view>
      <uni-icons type="left" size="24" color="#333333" @click="goBack()"></uni-icons>
    </view>
    <view class="login-form-content">
      <view class="logo-content align-center justify-center flex">
        <text class="title">忘记密码</text>
      </view>
      <view class="input-item flex align-center">
        <input v-model="forgetPwdForm.loginCode" class="input" type="text" placeholder="请输入您的邮箱" maxlength="30" />
      </view>
      <view class="input-item flex align-center">
        <input v-model="forgetPwdForm.code" type="text" class="input" placeholder="验证码" maxlength="20" />
        <text class="get-code" @click="goSendCode">获取验证码</text>
      </view>
      <view class="input-item flex align-center">
        <input v-model="forgetPwdForm.password" type="password" class="input" placeholder="密码（字母及数字不少于8位）"
          maxlength="20" />
      </view>
      <view class="input-item flex align-center">
        <input v-model="forgetPwdForm.confirmPassword" type="password" class="input" placeholder="确认密码" maxlength="20" />
      </view>
      <view class="action-btn">
        <button @click="handleRegister()" class="register-btn button-primary">
          确认
        </button>
      </view>
    </view>
    <verify-code ref="verifyCode" @success="onVerifySuccess"></verify-code>
  </view>
</template>

<script>
import { updateUserPwd } from "@/api/system/user";
import { sendCode } from "@/api/login";
import VerifyCode from "@/components/verify-code";
export default {
  components: { VerifyCode },
  data() {
    return {
      codeUrl: "",
      captchaEnabled: true,
      globalConfig: getApp().globalData.config,
      forgetPwdForm: {
        loginCode: "",
        password: "",
        confirmPassword: "",
        code: "",
        uuid: "",
        deviceName: "",
        deviceUuid: "",
      },
    };
  },
  created() {
    this.getDeviceInfo();
  },
  methods: {
    showVerify() {
      this.$refs.verifyCode.open()
    },
    // 获取当前手机设备名和设备id
    getDeviceInfo() {
      uni.getSystemInfo({
        success: (res) => {
          this.forgetPwdForm.deviceName = res.deviceModel;
          this.forgetPwdForm.deviceUuid = res.deviceId;
        }
      });
    },
    async goSendCode() {
      if (this.forgetPwdForm.loginCode === "") {
        this.$modal.msgError("请输入您的账号");
      } else {
        this.showVerify();

      }
    },
    onVerifySuccess(id) {
      console.log('验证成功，验证码ID：', id)
      // 执行后续操作，如登录、提交表单等
      sendCode({
        loginCode: this.forgetPwdForm.loginCode,
        bizType: 'RESETPWD',
        uuid: id,
      }).then((res) => {
        console.log('验证码发送成功', res);

        this.forgetPwdForm.uuid = res.data
        this.$modal.closeLoading();
        uni.showModal({

          title: "系统提示",
          content: "验证码发送成功！",
          success: function (res) {
          },
        });
      });
    },
    // 用户登录
    handleUserLogin() {
      this.$tab.navigateTo(`/pages/login`);
    },
    // 注册方法
    async handleRegister() {
      if (this.forgetPwdForm.loginCode === "") {
        this.$modal.msgError("请输入您的账号");
      } else if (this.forgetPwdForm.password === "") {
        this.$modal.msgError("请输入您的密码");
      } else if (this.forgetPwdForm.confirmPassword === "") {
        this.$modal.msgError("请再次输入您的密码");
      } else if (
        this.forgetPwdForm.password !== this.forgetPwdForm.confirmPassword
      ) {
        this.$modal.msgError("两次输入的密码不一致");
      } else if (this.forgetPwdForm.code === "" && this.captchaEnabled) {
        this.$modal.msgError("请输入验证码");
      } else {
        this.$modal.loading("密码重置中，请耐心等待...");
        this.forgetPwd();
      }
    },
    // 用户注册
    async forgetPwd() {
      let params = {
        loginCode: this.forgetPwdForm.loginCode,
        password: this.forgetPwdForm.password,
        code: this.forgetPwdForm.code,
        uuid: this.forgetPwdForm.uuid,
        deviceName: this.forgetPwdForm.deviceName,
        deviceUuid: this.forgetPwdForm.deviceUuid,
      }
      updateUserPwd(params)
        .then((res) => {
          console.log('密码重置', res);

          this.$modal.closeLoading();
          uni.showModal({
            title: "系统提示",
            content:
              "恭喜你，您的账号 " + this.forgetPwdForm.loginCode + " 重置密码成功！",
            success: function (res) {
              if (res.confirm) {
                uni.redirectTo({ url: `/pages/login` });
              }
            },
          });
        })
        .catch(() => {
        });
    },
    goBack() {
      // 返回上一个页面
      uni.navigateBack({
        delta: 1,
      });

    },
  },
};
</script>

<style lang="scss" scoped>
.normal-login-container {
  width: 100%;
  height: 100vh;
  background-image: url("/static/images/login-bg.png");
  background-repeat: no-repeat;
  background-position: top right;
  background-size: 70%;
  padding: 54rpx;
  position: relative;

  .login-form-content {
    position: absolute;
    top: 70%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    margin: 0 auto;
    width: 80%;

    .logo-content {
      .title {
        font-weight: 700;
        font-size: 50rpx;
        color: #141416;
        line-height: 80rpx;
      }
    }

    .input-item {
      height: 112rpx;
      background: #fcfcfd;
      border-radius: 20rpx;
      margin-top: 34rpx;
      padding: 40rpx 32rpx;

      .input {
        width: 100%;
        font-size: 40rpx;
        line-height: 48rpx;
        text-align: left;
      }

      .get-code {
        font-weight: 500;
        font-size: 32rpx;
        color: #9757d7;
        line-height: 48rpx;
        white-space: nowrap;
      }
    }

    .register-btn {
      margin: 40rpx;
    }
  }
}
</style>
