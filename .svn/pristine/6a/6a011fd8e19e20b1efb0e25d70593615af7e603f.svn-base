<template>
  <view class="chat-page">
    <nav-bar :title="chatTitle"></nav-bar>

    <scroll-view class="chat-content" scroll-y :scroll-top="scrollTop" @scroll="onScroll">
      <view v-if="!loading && chatList.length === 0" class="empty-wrap">
        <text class="empty-text">暂无聊天记录</text>
      </view>

      <view class="message-item" v-for="(item, index) in chatList" :key="item.msgId || index">
        <view class="message-time" v-if="item.timeText">
          <text>{{ item.timeText }}</text>
        </view>

        <view class="message-left" v-if="item.type === 'receive'">
          <image class="avatar" :src="item.avatar || defaultAvatar" mode="aspectFill"></image>
          <view class="message-bubble receive-bubble">
            <image
              class="message-img"
              v-if="isImageMsg(item)"
              :src="item.content"
              mode="widthFix"
            ></image>
            <text class="message-text" v-else>{{ item.content }}</text>
          </view>
        </view>

        <view class="message-right" v-else>
          <view class="message-bubble send-bubble">
            <text class="message-text">{{ item.content }}</text>
          </view>
          <image class="avatar" :src="myAvatar || defaultAvatar" mode="aspectFill"></image>
        </view>
      </view>
    </scroll-view>

    <view class="chat-footer">
      <uni-icons type="plus" size="24" class="plus-icon" @click="openMore"></uni-icons>
      <input
        class="msg-input"
        type="text"
        placeholder="发送消息"
        v-model="inputMsg"
        confirm-type="send"
        @confirm="sendMessage"
      />
      <button class="send-btn button-primary" :disabled="sending" @click="sendMessage">发送</button>
    </view>
  </view>
</template>

<script>
import config from "@/config";
import NavBar from "@/components/nav-bar/nav-bar.vue";
import {
  queryConvosMsgList,
  queryUserConvos,
  sendMsg,
  signConvosMsgs,
  zeroConvosUnread,
} from "@/api/message";

const baseUrl = config.baseUrl;

export default {
  components: {
    NavBar,
  },
  data() {
    return {
      loading: false,
      sending: false,
      chatTitle: "消息详情",
      convosId: 0,
      withId: 0,
      convosType: 0,
      currentUserId: 0,
      myAvatar: "/static/images/profile.jpg",
      peerAvatar: "/static/images/profile.jpg",
      defaultAvatar: "/static/images/profile.jpg",
      chatList: [],
      inputMsg: "",
      scrollTop: 0,
      queryData: {},
    };
  },
  onLoad(option) {
    const query = option || {};
    this.queryData = query;
    this.chatTitle = this.decodeText(query.name) || "消息详情";
    this.convosId = this.toNumber(query.convosId);
    this.withId = this.toNumber(query.withId);
    this.convosType = this.toNumber(query.type);
    this.peerAvatar = this.normalizeAvatar(this.decodeText(query.avatar));

    const userState = (this.$store && this.$store.state && this.$store.state.user) || {};
    this.currentUserId = this.toNumber(userState.id || (userState.userInfo || {}).memberId);
    this.myAvatar = this.normalizeAvatar(userState.avatar) || this.defaultAvatar;

    this.loadMessages();
  },
  onPullDownRefresh() {
    this.loadMessages().finally(() => uni.stopPullDownRefresh());
  },
  methods: {
    toNumber(value) {
      const n = Number(value);
      return Number.isNaN(n) ? 0 : n;
    },
    decodeText(value) {
      if (!value && value !== 0) {
        return "";
      }
      try {
        return decodeURIComponent(String(value));
      } catch (e) {
        return String(value);
      }
    },
    normalizeAvatar(url) {
      if (!url) {
        return this.defaultAvatar;
      }
      if (/^https?:\/\//i.test(url)) {
        return url;
      }
      return `${baseUrl}${url}`;
    },
    parseTime(value) {
      if (!value && value !== 0) {
        return 0;
      }
      const date = new Date(value);
      if (!Number.isNaN(date.getTime())) {
        return date.getTime();
      }
      const numberTime = Number(value);
      return Number.isNaN(numberTime) ? 0 : numberTime;
    },
    formatTime(value) {
      if (!value && value !== 0) {
        return "";
      }
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) {
        return String(value);
      }
      const pad = (num) => String(num).padStart(2, "0");
      return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(
        date.getHours(),
      )}:${pad(date.getMinutes())}`;
    },
    extractData(res) {
      if (!res) {
        return null;
      }
      return Object.prototype.hasOwnProperty.call(res, "data") ? res.data : res;
    },
    extractRows(res) {
      const data = this.extractData(res);
      if (Array.isArray(data)) {
        return data;
      }
      if (data && Array.isArray(data.rows)) {
        return data.rows;
      }
      if (data && Array.isArray(data.list)) {
        return data.list;
      }
      if (data && Array.isArray(data.records)) {
        return data.records;
      }
      if (Array.isArray(res && res.rows)) {
        return res.rows;
      }
      if (Array.isArray(res && res.list)) {
        return res.list;
      }
      return [];
    },
    async ensureConvos() {
      if (this.convosId || !this.withId) {
        return;
      }
      try {
        const res = await queryUserConvos({ withId: this.withId });
        const data = this.extractData(res);
        if (data && !Array.isArray(data) && data.convosId) {
          this.convosId = this.toNumber(data.convosId);
          if (!this.peerAvatar && data.bgImg) {
            this.peerAvatar = this.normalizeAvatar(data.bgImg);
          }
          return;
        }
        if (Array.isArray(data) && data.length > 0) {
          this.convosId = this.toNumber(data[0].convosId);
        }
      } catch (e) {
        // ignore
      }
    },
    mapMessageItem(item) {
      const senderId = this.toNumber(item.senderId || item.userId);
      const msgType = String(item.type || "text").toLowerCase();
      const isSelf = this.currentUserId > 0 && senderId === this.currentUserId;
      return {
        ...item,
        msgId: item.msgId || `${senderId}_${item.createTime || item.updateTime || Math.random()}`,
        type: isSelf ? "send" : "receive",
        msgType,
        content: item.content == null ? "" : String(item.content),
        avatar: isSelf
          ? this.myAvatar || this.defaultAvatar
          : this.normalizeAvatar(item.avatar) || this.peerAvatar || this.defaultAvatar,
        timeText: this.formatTime(item.createTime || item.updateTime),
        sortTime: this.parseTime(item.createTime || item.updateTime || item.snedTimeMills),
      };
    },
    async loadMessages() {
      if (this.loading) {
        return;
      }
      this.loading = true;
      try {
        await this.ensureConvos();
        const params = {};
        if (this.convosId) {
          params.convosId = this.convosId;
        }
        if (this.withId) {
          params.withId = this.withId;
        }
        params.convosType = this.convosType === 1 ? 1 : 0;

        const res = await queryConvosMsgList(params);
        const rows = this.extractRows(res);
        this.chatList = rows
          .map((item) => this.mapMessageItem(item))
          .sort((a, b) => (a.sortTime || 0) - (b.sortTime || 0));

        await this.signCurrentConvos(rows);
        this.scrollToBottom();
      } catch (e) {
        if (this.chatList.length === 0) {
          this.chatList = [];
        }
      } finally {
        this.loading = false;
      }
    },
    toValidMsgIdList(rows) {
      if (!Array.isArray(rows)) {
        return [];
      }
      const ids = rows
        .filter((item) => {
          const senderId = this.toNumber(item.senderId || item.userId);
          const isSelf = this.currentUserId > 0 && senderId === this.currentUserId;
          const readed = this.toNumber(item.readed);
          return !isSelf && readed === 0;
        })
        .map((item) => this.toNumber(item.msgId))
        .filter((id) => id > 0);
      return Array.from(new Set(ids));
    },
    async signCurrentConvos(rows) {
      if (!this.convosId && !this.withId) {
        return;
      }
      const msgIdList = this.toValidMsgIdList(rows);
      const body = {
        convosId: this.convosId || undefined,
        withId: this.withId || undefined,
        convosType: this.convosType === 1 ? 1 : 0,
        userId: this.currentUserId || undefined,
        msgId: msgIdList.length > 0 ? msgIdList[0] : undefined,
        msgIdList: msgIdList.length > 0 ? msgIdList : undefined,
      };
      try {
        const tasks = [zeroConvosUnread(body)];
        if (msgIdList.length > 0) {
          tasks.unshift(signConvosMsgs(body));
        }
        await Promise.all(tasks);
      } catch (e) {
        // ignore
      }
    },
    onScroll(e) {
      this.scrollTop = e.detail.scrollTop;
    },
    scrollToBottom() {
      this.$nextTick(() => {
        this.scrollTop = Number.MAX_SAFE_INTEGER;
      });
    },
    openMore() {
      uni.showActionSheet({
        itemList: ["选择图片", "拍摄照片"],
      });
    },
    isImageMsg(item) {
      const type = String(item.msgType || "").toLowerCase();
      return type === "image";
    },
    async sendMessage() {
      const content = this.inputMsg.trim();
      if (!content || this.sending) {
        return;
      }
      if (!this.withId && !this.convosId) {
        uni.showToast({ title: "会话参数缺失", icon: "none" });
        return;
      }

      const localId = `local_${Date.now()}`;
      this.chatList.push({
        msgId: localId,
        type: "send",
        msgType: "text",
        content,
        avatar: this.myAvatar || this.defaultAvatar,
        timeText: this.formatTime(new Date()),
        sortTime: Date.now(),
      });
      this.inputMsg = "";
      this.scrollToBottom();

      const payload = {
        convosId: this.convosId || 0,
        recipientId: this.withId || undefined,
        senderId: this.currentUserId || undefined,
        bizType: this.convosType === 1 ? 1 : 0,
        type: "text",
        content,
      };

      this.sending = true;
      try {
        const res = await sendMsg(payload);
        const data = this.extractData(res);
        if (data && typeof data === "object" && data.convosId) {
          this.convosId = this.toNumber(data.convosId) || this.convosId;
        }
        await this.loadMessages();
      } catch (e) {
        this.chatList = this.chatList.filter((item) => item.msgId !== localId);
        uni.showToast({ title: "发送失败", icon: "none" });
      } finally {
        this.sending = false;
      }
    },
  },
};
</script>

<style scoped>
.chat-page {
  display: flex;
  flex-direction: column;
  height: 100vh;
  background-color: #ffffff;
}

.chat-content {
  flex: 1;
  padding: 20rpx;
  box-sizing: border-box;
}

.empty-wrap {
  padding: 120rpx 0;
  text-align: center;
}

.empty-text {
  font-size: 28rpx;
  color: #999999;
}

.message-time {
  text-align: center;
  margin: 16rpx 0;
}

.message-time text {
  font-size: 22rpx;
  color: #999;
  background-color: #f0f0f0;
  padding: 8rpx 20rpx;
  border-radius: 16rpx;
}

.message-item {
  margin-bottom: 24rpx;
}

.avatar {
  width: 72rpx;
  height: 72rpx;
  border-radius: 50%;
  flex-shrink: 0;
}

.message-bubble {
  max-width: 520rpx;
  padding: 20rpx;
  border-radius: 16rpx;
  box-sizing: border-box;
  word-break: break-all;
}

.message-left {
  display: flex;
  align-items: flex-start;
}

.message-left .avatar {
  margin-right: 20rpx;
}

.receive-bubble {
  background-color: #ffffff;
  border: 1px solid #ececec;
  border-top-left-radius: 0;
}

.message-right {
  display: flex;
  justify-content: flex-end;
  align-items: flex-start;
}

.message-right .avatar {
  margin-left: 20rpx;
}

.send-bubble {
  background-color: #5f2aff;
  border-top-right-radius: 0;
}

.send-bubble .message-text {
  color: #ffffff;
}

.message-img {
  width: 240rpx;
  height: auto;
  border-radius: 8rpx;
}

.message-text {
  font-size: 28rpx;
  line-height: 1.5;
  color: #333333;
}

.chat-footer {
  display: flex;
  align-items: center;
  min-height: 100rpx;
  padding: 0 20rpx;
  background-color: #ffffff;
  border-top: 1px solid #eeeeee;
}

.plus-icon {
  color: #666666;
  margin-right: 16rpx;
}

.msg-input {
  flex: 1;
  height: 64rpx;
  background-color: #f5f5f5;
  border-radius: 32rpx;
  padding: 0 20rpx;
  font-size: 28rpx;
}

.send-btn {
  width: 120rpx;
  height: 64rpx;
  line-height: 64rpx;
  font-size: 28rpx;
  margin-left: 16rpx;
  border: none;
}
</style>
