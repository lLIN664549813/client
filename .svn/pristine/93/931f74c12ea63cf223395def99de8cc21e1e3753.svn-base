<!--
 * @Description: '转账记录页面'
 * @Version: 1.0
 * @Autor:'zhanglin'
 * @Date: 2026-02-11 11:00:00
 * @LastEditors: 'zhanglin'
 * @LastEditTime: 2026-02-11 11:00:00
 -->
<template>
    <view class="record-page">
        <nav-bar title="转账记录"></nav-bar>

        <view class="tab-group">
            <view class="tab-item" :class="{ active: recordType === 'buy' }" @click="switchType('buy')">
                <text>买入</text>
            </view>
            <view class="tab-item" :class="{ active: recordType === 'sell' }" @click="switchType('sell')">
                <text>卖出</text>
            </view>
            <view class="tab-item" :class="{ active: recordType === 'other' }" @click="switchType('other')">
                <text>其他</text>
            </view>
        </view>

        <view class="record-content">
            <view class="record-list">
                <view class="record-item" v-for="(item, index) in recordList" :key="index">
                    <view class="flex justify-between algin-center">
                        <text>{{ item.title }}</text>
                        <text>{{ item.amount }}</text>
                    </view>
                    <view v-if="item.desc">{{ item.desc }}</view>
                    <view class="record-time">{{ item.time }}</view>
                </view>
            </view>

            <text v-if="!hasMore && recordList.length > 0" class="no-more">无更多数据</text>
        </view>
    </view>
</template>

<script>
import NavBar from "@/components/nav-bar/nav-bar.vue";
import { getAccountBills } from "@/api/mine";

export default {
    components: {
        NavBar
    },
    data() {
        return {
            recordType: "buy",
            recordList: [],
            pageNum: 1,
            pageSize: 20,
            hasMore: true,
            loading: false,
            windowHeight: 0
        };
    },
    onLoad() {
        try {
            const info = uni.getSystemInfoSync();
            this.windowHeight = Number(info.windowHeight || 0);
        } catch (e) {
            this.windowHeight = 0;
        }
    },
    onShow() {
        this.resetAndLoad();
    },
    onReachBottom() {
        this.loadBills();
    },
    onPageScroll(event) {
        this.checkNeedLoadByPageScroll(event);
    },
    methods: {
        getBillType() {
            if (this.recordType === 'sell') {
                return 0;
            }
            if (this.recordType === 'buy') {
                return 1;
            }
            return undefined;
        },
        buildQueryParams() {
            const billType = this.getBillType();
            const params = {
                pageNum: this.pageNum,
                pageSize: this.pageSize,
                assetType: 'balance'
            };
            if (billType !== undefined) {
                params.billType = billType;
            }
            return params;
        },
        async resetAndLoad() {
            this.pageNum = 1;
            this.hasMore = true;
            this.recordList = [];
            await this.loadBills();
        },
        async loadBills() {
            if (this.loading || !this.hasMore) {
                return;
            }
            this.loading = true;
            try {
                const res = await getAccountBills(this.buildQueryParams());
                const rows = this.extractRows(res);
                const mappedRows = rows.map(item => {
                    const amount = Number(item.amount);
                    const isIncome = amount >= 0;
                    return {
                        title: item.dealTypeName || item.dealName || item.transactionType || '账户变动',
                        desc: item.transactionNo ? `流水号: ${item.transactionNo}` : '',
                        amount: `${item.assetType || 'USDT'} ${isIncome ? '+' : ''}${Number.isNaN(amount) ? item.amount : amount}`,
                        time: this.formatTime(item.createTime)
                    };
                });
                this.recordList = this.recordList.concat(mappedRows);

                this.hasMore = rows.length > 0;
                if (this.hasMore) {
                    this.pageNum += 1;
                }
            } catch (e) {
                if (this.pageNum === 1) {
                    this.recordList = [];
                }
                this.hasMore = false;
            } finally {
                this.loading = false;
            }
        },
        extractRows(res) {
            if (!res) {
                return [];
            }
            const data = res.data || res;
            if (Array.isArray(data)) {
                return data;
            }
            if (Array.isArray(data.rows)) {
                return data.rows;
            }
            if (Array.isArray(data.list)) {
                return data.list;
            }
            if (Array.isArray(res.rows)) {
                return res.rows;
            }
            return [];
        },
        formatTime(value) {
            if (!value) {
                return '--';
            }
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
                return String(value);
            }
            const pad = (num) => String(num).padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
        },
        async switchType(type) {
            if (this.recordType === type) {
                return;
            }
            this.recordType = type;
            await this.resetAndLoad();
        },
        checkNeedLoadByPageScroll(event) {
            if (this.loading || !this.hasMore || !this.windowHeight) {
                return;
            }
            const scrollTop = Number((event && event.scrollTop) || 0);
            const query = uni.createSelectorQuery().in(this);
            query.select('.record-page').boundingClientRect((rect) => {
                if (!rect || !rect.height) {
                    return;
                }
                const distanceToBottom = rect.height - (scrollTop + this.windowHeight);
                if (distanceToBottom <= 80) {
                    this.loadBills();
                }
            }).exec();
        }
    }
};
</script>

<style scoped lang="scss">
.record-page {
    min-height: 100vh;
    width: 100%;
    background-color: #ffffff;
}

.record-content {
    padding: 30rpx;
    box-sizing: border-box;
}

.tab-group {
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    gap: 20rpx;
    margin-bottom: 18rpx;
    margin-top: 52rpx;

    .tab-item {
        width: 208rpx;
        height: 98rpx;
        background: #EDEEF0;
        border-radius: 12rpx 12rpx 12rpx 12rpx;
        border: 0rpx solid rgba(237, 238, 240, 0.8784);
        line-height: 98rpx;
        font-weight: 400;
        font-size: 28rpx;
        color: #0B1526;
        text-align: center;
    }

    .tab-item.active {
        background: #F4F0FF;
        border-radius: 12rpx 12rpx 12rpx 12rpx;
        border: 2rpx solid #5E28FF;
        color: #5F2AFF;
    }
}

.record-list {
    margin-bottom: 40rpx;
}

.record-item {
    background-color: #fff;
    padding: 20rpx 30rpx;
    margin-bottom: 48rpx;
    font-weight: 600;
    font-size: 32rpx;
    color: #343434;
    line-height: 48rpx;
    box-shadow: 0rpx 8rpx 60rpx 0rpx rgba(54, 41, 183, 0.07);
    border-radius: 20rpx;
}

.record-time {
    font-weight: 600;
    font-size: 30rpx;
    color: #979797;
    line-height: 32rpx;
}

.no-more {
    display: block;
    text-align: center;
    font-weight: 400;
    font-size: 36rpx;
    color: #0B1526;
    line-height: 50rpx;
    padding: 54rpx 0;
}
</style>
